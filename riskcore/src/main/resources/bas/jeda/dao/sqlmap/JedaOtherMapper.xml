<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bas.jeda.dao.sqlmap">     
    <resultMap id="BaseResultMap" type="bas.jeda.dao.JedaMenu" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Mar 02 21:49:14 CST 2015.
        -->
        <id column="MENU_ID" property="menuId" jdbcType="VARCHAR" />
        <result column="PARENT_MENU_ID" property="parentMenuId" jdbcType="VARCHAR" />
        <result column="MENU_NAME" property="menuName" jdbcType="VARCHAR" />
        <result column="MENU_URL" property="menuUrl" jdbcType="VARCHAR" />
        <result column="MENU_DESCRIPTION" property="menuDescription" jdbcType="VARCHAR" />
        <result column="MENU_IFRAME" property="menuIframe" jdbcType="DECIMAL" />
        <result column="MENU_ICON" property="menuIcon" jdbcType="VARCHAR" />
        <result column="MENU_ORDER" property="menuOrder" jdbcType="DECIMAL" />
        <result column="MENU_READ_ONLY" property="menuReadOnly" jdbcType="DECIMAL" />
        <result column="MENU_OPEN_IN_HOME" property="menuOpenInHome" jdbcType="DECIMAL" />
        <result column="MENU_VERSION" property="menuVersion" jdbcType="DECIMAL" />
        <result column="MENU_CREATOR" property="menuCreator" jdbcType="VARCHAR" />
        <result column="MENU_CREATED" property="menuCreated" jdbcType="TIMESTAMP" />
        <result column="MENU_MODIFIER" property="menuModifier" jdbcType="VARCHAR" />
        <result column="MENU_MODIFIED" property="menuModified" jdbcType="TIMESTAMP" />
    </resultMap>
    
    
    <resultMap id="BaseResultMapUser" type="bas.jeda.dao.JedaUser" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Mar 02 21:49:14 CST 2015.
        -->
        <id column="USER_ID" property="userId" jdbcType="VARCHAR" />
        <result column="POSITION_ID" property="positionId" jdbcType="VARCHAR" />
        <result column="ORG_ID" property="orgId" jdbcType="VARCHAR" />
        <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
        <result column="USER_PASSWORD" property="userPassword" jdbcType="VARCHAR" />
        <result column="USER_ID_NO" property="userIdNo" jdbcType="VARCHAR" />
        <result column="USER_GENDER" property="userGender" jdbcType="VARCHAR" />
        <result column="USER_EMAIL" property="userEmail" jdbcType="VARCHAR" />
        <result column="USER_BIRTHDAY" property="userBirthday" jdbcType="DATE" />
        <result column="USER_ADDRESS" property="userAddress" jdbcType="VARCHAR" />
        <result column="USER_POST" property="userPost" jdbcType="VARCHAR" />
        <result column="USER_TEL" property="userTel" jdbcType="VARCHAR" />
        <result column="USER_MOBILE" property="userMobile" jdbcType="VARCHAR" />
        <result column="USER_DESCRIPTION" property="userDescription" jdbcType="VARCHAR" />
        <result column="USER_ENABLED" property="userEnabled" jdbcType="DECIMAL" />
        <result column="USER_LOCKED" property="userLocked" jdbcType="DECIMAL" />
        <result column="USER_ACCOUNT_NONEXPIRED" property="userAccountNonexpired" jdbcType="DECIMAL" />
        <result column="USER_ACCOUNT_NONLOCKED" property="userAccountNonlocked" jdbcType="DECIMAL" />
        <result column="USER_CREDENTIALS_NONEXPIRED" property="userCredentialsNonexpired" jdbcType="DECIMAL" />
        <result column="USER_ORDER" property="userOrder" jdbcType="DECIMAL" />
        <result column="USER_VERSION" property="userVersion" jdbcType="DECIMAL" />
        <result column="USER_CREATOR" property="userCreator" jdbcType="VARCHAR" />
        <result column="USER_CREATED" property="userCreated" jdbcType="TIMESTAMP" />
        <result column="USER_MODIFIER" property="userModifier" jdbcType="VARCHAR" />
        <result column="USER_MODIFIED" property="userModified" jdbcType="TIMESTAMP" />
        <result column="ADDVCD" property="addvcd" jdbcType="VARCHAR" />
        <result column="VISITS" property="visits" jdbcType="DECIMAL" />
        <result column="LOGIN_TIME" property="loginTime" jdbcType="VARCHAR" />
        <result column="LOGIN_NAME" property="loginName" jdbcType="VARCHAR" />
    </resultMap>
    <select id="queryMenuByUser" parameterType="hashmap" resultMap="BaseResultMap">
        select * from JEDA_Menu where menu_id in(
        select distinct menu.menu_id from JEDA_Menu menu
        left join JEDA_Menu pm on menu.parent_MENU_ID=pm.menu_ID
        left join JEDA_ROLE_USER r on r.USER_ID=#{userid}
        left join JEDA_ROLE_MENU rm on rm.menu_ID=menu.menu_ID where rm.role_id=r.role_ID
        ) 
        <if test="parent==null">
            and parent_menu_id is null
        </if>
        <if test="parent!=null">
            and parent_menu_id = #{parent}
        </if>
        order by MENU_ORDER
    </select>          
    
    <select id="queryUsersByRole"  parameterType="hashmap"  resultMap="BaseResultMapUser">
        select a.* from jeda_user a
        inner join jeda_role_user b on a.user_id=b.user_id 
        where b.role_id=#{roleid}
    </select>
    
    <select id="queryUsersByRoleAndOrg"  parameterType="hashmap"  resultMap="BaseResultMapUser">
        select a.* from jeda_user a
        inner join jeda_role_user b on a.user_id=b.user_id 
        where 1=1 
        <if test="roleid!=null">
            and b.role_id=#{roleid}
        </if>
    </select>

    <select id="getMenubyPId"  parameterType="hashmap" resultType="hashmap" >
        SELECT M.MENU_ID,
       M.PARENT_MENU_ID,
       M.MENU_NAME,
       M.MENU_URL,
       (SELECT COUNT(M1.MENU_ID)
          FROM JEDA_MENU M1
         WHERE M1.PARENT_MENU_ID = '_' || M.MENU_ID) AS COUNT
        FROM JEDA_MENU M
        WHERE M.PARENT_MENU_ID = #{pId}
    </select>
    
    <select id="selectUserByRole"  parameterType="hashmap" resultType="hashmap" >
        select t.user_id,t.position_id,t.user_name,m.org_name from jeda_user t
        inner join jeda_org m on t.org_id=m.org_id
        where t.user_id in 
        (select distinct(user_id) from (
            select a.* from jeda_user a inner join jeda_role_user b on a.user_id=b.user_id
        where 1=1 
        <if test="roleid!=null">
            and b.role_id in
            <foreach item="roleid" index="index" collection="roleid" open="(" separator="," close=")">
                #{roleid}
            </foreach>
        </if>
        <if test="orgid!=null">
            and a.org_id in
            <foreach item="orgid" index="index" collection="orgid" open="(" separator="," close=")">
                #{orgid}
            </foreach>
        </if>
        ))
    </select>
     
</mapper>
